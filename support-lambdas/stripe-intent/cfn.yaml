AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Lambda/API gateway for creating Stripe Setup Intents

Parameters:
  Stage:
    Description: Stage name
    Type: String
    AllowedValues:
      - PROD
      - CODE
    Default: CODE

Mappings:
  StageMap:
    CODE:
      DomainName: stripe-intent-code.support.guardianapis.com
      StripeConfig: test
      CorsOrigin: "'*'"
    PROD:
      DomainName: stripe-intent.support.guardianapis.com
      StripeConfig: live
      CorsOrigin: "'https://support.theguardian.com'"
  Constants:
    Alarm:
      Process: Follow the process in https://docs.google.com/document/d/1_3El3cly9d7u_jPgTcRjLxmdG2e919zCLvmcFCLOYAk/edit
      Urgent: URGENT 9-5 -

Conditions:
  CreateProdMonitoring: !Equals [ !Ref Stage, PROD ]

Globals:
  Api:
    Cors:
      AllowOrigin: !FindInMap [ StageMap, !Ref Stage, CorsOrigin ]
      AllowHeaders: "'Content-Type'"
      AllowMethods: "'*'"

Resources:
  LambdaFunctionOverHttps:
    Type: AWS::Serverless::Function
    Properties:
      Description: Returns a stripe setup intent token so we can get authorisation of a recurring payment on the client side
      FunctionName:
        !Sub stripe-intent-${Stage}
      Handler: com.gu.stripeIntent.Handler::handleRequest
      CodeUri:
        Bucket: support-workers-dist
        Key: !Sub support/${Stage}/stripe-intent/stripe-intent.jar
      MemorySize: 2048
      Runtime: java8
      Timeout: 300
      Environment:
        Variables:
          Stage: !Ref Stage
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
              - lambda:InvokeFunction
            Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/stripe-intent-${Stage}:log-stream:*"
        - Statement:
          - Effect: Allow
            Action: s3:GetObject
            Resource:
              - !Sub
                - arn:aws:s3:::gu-reader-revenue-private/stripe/${stripeConfig}-stripe-regular.private.conf
                - stripeConfig:
                    !FindInMap [ StageMap, !Ref Stage, StripeConfig ]
      Events:
        HttpPost:
          Type: Api
          Properties:
            Path: '/stripe-intent'
            Method: post

  DomainName:
    Type: "AWS::ApiGateway::DomainName"
    Properties:
      RegionalCertificateArn: # only for *.support.guardianapis.com
        !Sub arn:aws:acm:${AWS::Region}:${AWS::AccountId}:certificate/b384a6a0-2f54-4874-b99b-96eeff96c009
      DomainName: !FindInMap [ StageMap, !Ref Stage, DomainName ]
      EndpointConfiguration:
        Types:
          - REGIONAL

  BasePathMapping:
    Type: "AWS::ApiGateway::BasePathMapping"
    Properties:
      RestApiId: !Ref ServerlessRestApi # auto generated by the Transform
      DomainName: !Ref DomainName
      Stage: Stage
    DependsOn: ServerlessRestApiProdStage # auto generated by the Transform

  DNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: support.guardianapis.com.
      Name: !FindInMap [ StageMap, !Ref Stage, DomainName ]
      Comment: !Sub CNAME for strip-intent API ${Stage}
      Type: CNAME
      TTL: '120'
      ResourceRecords:
        - !GetAtt [ DomainName, RegionalDomainName ]

  4XXAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:reader-revenue-dev
      AlarmName: !Sub High 4XX rate for support-${Stage}-stripe-intent
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Dimensions:
        - Name: ApiName
          Value: !Sub support-${Stage}-stripe-intent
        - Name: Stage
          Value: !Ref Stage
        - Name: Method
          Value: POST
        - Name: Resource
          Value: /stripe-intent
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      Period: 60
      EvaluationPeriods: 1
      Statistic: Sum

  5XXAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions:
        - !Sub arn:aws:sns:${AWS::Region}:${AWS::AccountId}:reader-revenue-dev
      AlarmName: !Sub High 5XX rate for support-${Stage}-stripe-intent
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Dimensions:
        - Name: ApiName
          Value: !Sub support-${Stage}-stripe-intent
        - Name: Stage
          Value: !Ref Stage
        - Name: Method
          Value: POST
        - Name: Resource
          Value: /stripe-intent
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      Period: 60
      EvaluationPeriods: 1
      Statistic: Sum
