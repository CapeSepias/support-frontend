@import admin.settings.AllSettings
@import assets.{AssetsResolver, RefPath, StyleContent}
@import views.{EmptyDiv, Preload, ReactDiv, SSRContent}
@(
  title: String,
  mainElement: ReactDiv,
  mainJsBundle: RefPath,
  mainStyleBundle: Either[RefPath, StyleContent],
  description: Option[String] = None,
  canonicalLink: Option[String] = None,
  hrefLangLinks: Map[String, String] = Map(),
  csrf: Option[String] = None,
  preload: List[Preload] = Nil
)(body: Html = Html(""))(implicit assets: AssetsResolver, request: RequestHeader, settings: AllSettings)

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="nFrhJ3suC2OpKRasEkZyH1KZKpSZc-ofno_uunJgfvg" />
    @for(Preload(href, as, typeAttr) <- preload) {
      <link rel="preload" href="@href" as="@as" type="@typeAttr" crossorigin>
    }

    @csrf.map { token =>
      <script type="text/javascript">
      window.guardian = window.guardian || {};
      if(!window.guardian.csrf) {
        window.guardian.csrf = {token: "@token"}
      }
    </script>
    }

    @description.map { definedDescription =>
      <meta name="description" content="@definedDescription" />
      <meta property="og:description" content="@definedDescription" />
    }

    @canonicalLink.map { definedCanonicalLink =>
      <link rel="canonical" href="@definedCanonicalLink" />
    }

    @for((lang, link) <- hrefLangLinks){
      <link rel="alternate" href="@link" hreflang="@lang" />
    }

    @settingsScript(settings)

    <title>@title</title>
    <meta property="og:title" content="@title"/>

    @optimizeScript()

    @linkedCss(path: RefPath) = {
      <link rel="stylesheet" href="@assets(path)">
    }

    @inline(inlineCss: StyleContent) = {
      <style>
      @inlineCss.value
      </style>
    }

    @mainStyleBundle.fold(linkedCss, inline)

    <link rel="shortcut icon" type="image/png" href="@routes.Favicon.get()">
    <link rel="apple-touch-icon" sizes="152x152" href="@assets("images/favicons/152x152.png")">
    <link rel="apple-touch-icon" sizes="144x144" href="@assets("images/favicons/144x144.png")">
    <link rel="apple-touch-icon" sizes="120x120" href="@assets("images/favicons/120x120.png")">
    <link rel="apple-touch-icon" sizes="114x114" href="@assets("images/favicons/114x114.png")">
    <link rel="apple-touch-icon" sizes="72x72" href="@assets("images/favicons/72x72.png")">
    <link rel="apple-touch-icon-precomposed" href="@assets("images/favicons/57x57.png")">

    <script type="application/ld+json">
		{
			"@@context": "http://schema.org",
			"@@type": "Organization",
			"name": "Support the Guardian",
			"url": "https://support.theguardian.com",
			"logo": "https://support.theguardian.com@assets("images/favicons/152x152.png")"
		}
	</script>

    <script async type="text/javascript" src="@assets("googleTagManagerScript.js")"></script>
    <link rel="preload"  as="script" href="@assets(mainJsBundle)">

    </head>
  <body class="header-tweaks">
    <script>
      (function(window, document) {
      var head = document.getElementsByTagName('head')[0];
      var hideIframeStyle = document.createElement('style');
      hideIframeStyle.innerHTML= ".guardianFontLoader {display: none;}";
      head.append(hideIframeStyle);
      var useFont = function(font) {
        if (font.css) {
          var style = document.createElement('style');
          style.innerHTML = font.css;
          head.appendChild(style);
        }
      };

      var loadFonts = function() {
        var iframe = document.createElement('iframe');
        // TODO use prod link to font-loader
        iframe.src = 'https://176c9a2c.ngrok.io/font-loader';
        iframe.classList = 'guardianFontLoader';
        // add iframe and wait for message
        window.addEventListener('message', function(e) {
        if (
          e &&
          e.data &&
          e.data.name &&
          e.data.name === 'guardianFonts' &&
          e.data.fonts &&
          e.source === iframe.contentWindow
        ) {
          e.data.fonts.forEach(useFont);
        }
        });
        document.body.appendChild(iframe);
     };
     loadFonts();
     })(window, document);
    </script>
    <noscript>
      <div style="text-align: center;
        font-size: 30px;
        padding-left: 20px;
        padding-right: 20px;
        background-color: #e9e939;">
        Please enable JavaScript - we use it to provide the best experience for Guardian&nbsp;Supporters.<br/>
        <a href="https://www.enable-javascript.com/">Click here for instructions to do so in your browser.</a>
      </div>
    </noscript>

    @emptyDiv(id: EmptyDiv) = {
    <div class="gu-render-to" id="@id.value"></div>
  }

    @withContent(ssrContent: SSRContent) = {
    <div class="gu-render-to" id="@ssrContent.value">@ssrContent.content</div>
  }

    @mainElement.fold(emptyDiv, withContent)

    <script src="https://polyfill.io/v2/polyfill.min.js?features=default,Array.prototype.find,fetch,Array.prototype.includes,Number.isInteger,Object.values,Object.entries"></script>
    <script defer id="stripe-js" src="https://js.stripe.com/v3/"></script>
    <script type="text/javascript">
    window.guardian = window.guardian || {};
    window.guardian.gitCommitId = '@app.BuildInfo.gitCommitId';
	</script>

    @body

    @* This script is intentionally at the bottom of the file. Please check
    all the critical flows work correctly if you change its position *@
    <script type="text/javascript" src="@assets(mainJsBundle)"></script>
      <!-- build-commit-id: @app.BuildInfo.gitCommitId -->
  </body>
</html>
